---
import Layout from "@/layouts/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import placeholderImage from "@/content/blog/placeholder.jpg";
import {
    getPayloadPosts,
    isPayloadCmsEnabled,
    parsePayloadPostToListItem,
    type PayloadBlogListItem,
} from "@/lib/payload";

const contentBlogs = await getCollection("blog");
type Blog = CollectionEntry<"blog">;

/** Unified blog item for listing: from content collection or Payload CMS */
type BlogListItem =
    | {
          source: "content";
          id: string;
          title: string;
          author: string;
          authorProfileImageUrl?: never;
          date: Date;
          imageMetadata: ImageMetadata;
      }
    | PayloadBlogListItem;

const payloadPosts = isPayloadCmsEnabled() ? await getPayloadPosts() : [];

const blogs: BlogListItem[] = [
    ...contentBlogs.map((b: Blog) => ({
        source: "content" as const,
        id: b.id,
        title: b.data.title,
        author: b.data.author,
        date: b.data.date,
        imageMetadata: b.data.image as ImageMetadata,
    })),
    ...payloadPosts.map((p) =>
        parsePayloadPostToListItem(p, placeholderImage.src),
    ),
].sort((a, b) => b.date.getTime() - a.date.getTime());
---

<Layout title="Blog">
    <div class="flex flex-col gap-64">
        <section
            id="landing"
            class="relative items-center flex h-[40vh] min-h-0 flex-col justify-center gap-12"
        >
            <h1
                class="text-h1 text-center max-[600px]:text-h2 motion-preset-slide-up-md"
            >
                The latest updates from us
            </h1>
            <p
                class="text-body leading-[160%] text-center motion-preset-fade-lg"
            >
                Keep up on our development, journeys, events, and more.
            </p>
            <div
                class="absolute -top-1/2 motion-preset-fade-lg motion-delay-300 left-1/2 -translate-x-1/2 -z-50 size-[800px] max-[640px]:size-[550px]"
                style="background: radial-gradient(circle, var(--color-accent) 0%, transparent 65%); opacity: 0.4;"
            >
            </div>
        </section>
        <section id="blogs" class="flex flex-col gap-8 py-12">
            {
                blogs.map((blog: BlogListItem) => (
                    <a
                        href={`/blog/${blog.id}`}
                        class="rounded-6 border border-stroke h-fit bg-fg-1 duration-150 ease-out hover:border-accent flex max-[700px]:flex-col"
                    >
                        {blog.source === "content" ? (
                            <Image
                                src={blog.imageMetadata}
                                width={670}
                                height={420}
                                alt=""
                                class="aspect-video h-auto w-[30%] min-w-[30%] max-[700px]:w-full rounded-t-6 object-cover md:rounded-l-6 md:rounded-t-none"
                            />
                        ) : (
                            <Image
                                src={blog.imageUrl}
                                width={blog.imageWidth ?? 670}
                                height={blog.imageHeight ?? 420}
                                alt={blog.imageAlt}
                                class="aspect-video h-auto w-[30%] min-w-[30%] max-[700px]:w-full rounded-t-6 object-cover md:rounded-l-6 md:rounded-t-none"
                            />
                        )}
                        <div class="flex flex-col gap-6 p-16 justify-center max-[500px]:p-16">
                            <h2 class="w-full text-h3 max-[1000px]:text-h4">
                                {blog.title}
                            </h2>
                            <div class="flex gap-16 flex-wrap items-center text-text-subtitle">
                                {blog.source === "payload" &&
                                blog.authorProfileImageUrl ? (
                                    <Image
                                        src={blog.authorProfileImageUrl}
                                        alt=""
                                        width={
                                            blog.authorProfileImageWidth ?? 96
                                        }
                                        height={
                                            blog.authorProfileImageHeight ?? 96
                                        }
                                        class="size-24 shrink-0 rounded-full object-cover"
                                    />
                                ) : null}
                                <p class="text-body leading-[150%]">
                                    {blog.author}
                                </p>
                                <p class="text-body leading-[150%]">
                                    {blog.date.toLocaleDateString("en-US", {
                                        year: "numeric",
                                        month: "long",
                                        day: "numeric",
                                        timeZone: "UTC",
                                    })}
                                </p>
                            </div>
                        </div>
                    </a>
                ))
            }
        </section>
    </div>
</Layout>
