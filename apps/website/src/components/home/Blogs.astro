---
import { getCollection, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import placeholderImage from "@/content/blog/placeholder.jpg";
import NewsletterForm from "@/components/ui/NewsletterForm";
import { ArrowUpRightIcon } from "@phosphor-icons/react";
import {
    getPayloadPosts,
    isPayloadCmsEnabled,
    parsePayloadPostToListItem,
    type PayloadBlogListItem,
} from "@/lib/payload";

const contentBlogs = await getCollection("blog");
type Blog = CollectionEntry<"blog">;

type BlogListItem =
    | {
          source: "content";
          id: string;
          title: string;
          author: string;
          authorProfileImageUrl?: never;
          date: Date;
          imageMetadata: ImageMetadata;
      }
    | PayloadBlogListItem;

const payloadPosts = isPayloadCmsEnabled() ? await getPayloadPosts() : [];
const blogs: BlogListItem[] = [
    ...contentBlogs.map((b: Blog) => ({
        source: "content" as const,
        id: b.id,
        title: b.data.title,
        author: b.data.author,
        date: b.data.date,
        imageMetadata: b.data.image as ImageMetadata,
    })),
    ...payloadPosts.map((p) =>
        parsePayloadPostToListItem(p, placeholderImage.src),
    ),
]
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);
---

<section id="blogs" class="flex flex-col gap-16">
    <h1 class="text-h2">The latest updates from us</h1>
    <div
        class="grid grid-cols-3 gap-8 max-[1200px]:h-fit min-h-0 max-[1200px]:grid-cols-2 max-[850px]:grid-cols-1"
    >
        <div
            class="grid grid-cols-2 grid-rows-2 gap-8 col-span-2 row-span-2 max-[850px]:col-span-1 max-[850px]:row-span-1 max-[650px]:grid-cols-1 max-[650px]:grid-rows-4"
        >
            {
                blogs.map((blog: BlogListItem) => (
                    <a
                        href={`/blog/${blog.id}`}
                        class="flex flex-col rounded-6 border overflow-clip border-stroke bg-fg-1 duration-150 ease-out hover:border-accent"
                    >
                        {blog.source === "content" ? (
                            <Image
                                src={blog.imageMetadata}
                                width={670}
                                height={420}
                                alt=""
                                class="aspect-video h-auto w-full object-cover"
                            />
                        ) : (
                            <Image
                                src={blog.imageUrl}
                                width={blog.imageWidth ?? 670}
                                height={blog.imageHeight ?? 420}
                                alt={blog.imageAlt}
                                class="aspect-video h-auto w-full object-cover"
                            />
                        )}
                        <div class="flex w-full flex-col gap-8 p-16 h-fit">
                            <h2 class="w-full text-h4">{blog.title}</h2>
                            <div class="flex gap-16 flex-wrap items-center align-top">
                                {blog.source === "payload" &&
                                blog.authorProfileImageUrl ? (
                                    <Image
                                        src={blog.authorProfileImageUrl}
                                        alt=""
                                        width={
                                            blog.authorProfileImageWidth ?? 96
                                        }
                                        height={
                                            blog.authorProfileImageHeight ?? 96
                                        }
                                        class="size-24 shrink-0 rounded-full object-cover"
                                    />
                                ) : null}
                                <div class="flex flex-col gap-2">
                                    <p class="w-fit text-body text-text-subtitle leading-[150%]">
                                        {blog.author}
                                    </p>
                                    <p class="w-fit text-body text-text-subtitle leading-[150%]">
                                        {blog.date.toLocaleDateString("en-US", {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                            timeZone: "UTC",
                                        })}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </a>
                ))
            }
        </div>
        <div
            class="col-span-1 row-span-2 grid grid-cols-1 max-[1200px]:col-span-2 max-[1200px]:grid-cols-2 grid-rows-2 max-[850px]:h-fit gap-8 max-[850px]:grid-cols-1 max-[850px]:col-span-1 max-[850px]:row-span-1"
        >
            <div
                class="bg-fg-1 border relative overflow-clip border-stroke rounded-6 p-16 flex max-[850px]:h-fit justify-end flex-col gap-8"
            >
                <h2 class="text-h4">Subscribe to our newsletter</h2>
                <p class="text-body text-text-subtitle leading-[150%]">
                    Stay up to date with the latest news and updates.
                </p>
                <NewsletterForm client:visible />
                <div
                    class="absolute -bottom-1/2 -left-1/2 -z-50 size-[600px] max-[640px]:size-[200px]"
                    style="background: radial-gradient(circle, var(--color-accent) 0%, transparent 50%); opacity: 0.4;"
                >
                </div>
            </div>
            <a
                href="/blog"
                class="bg-fg-1 relative border overflow-clip border-stroke hover:border-accent duration-150 group rounded-6 p-16 flex max-[850px]:h-fit justify-end flex-col gap-8"
            >
                <div class="flex gap-8 items-center">
                    <h2 class="text-h4">See more posts</h2>
                    <ArrowUpRightIcon
                        className="group-hover:rotate-45 transition-transform duration-150"
                        size={20}
                    />
                </div>
                <p class="text-body text-text-subtitle leading-[150%]">
                    Learn about development, our journeys, and updates.
                </p>
                <div
                    class="absolute -bottom-1/2 -right-1/2 -translate-x-1/2 -z-50 size-[600px] max-[640px]:size-[200px]"
                    style="background: radial-gradient(circle, var(--color-accent) 0%, transparent 50%); opacity: 0.4;"
                >
                </div>
            </a>
        </div>
    </div>
</section>
