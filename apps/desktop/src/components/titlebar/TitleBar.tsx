import { MinusIcon, SquareIcon, ListIcon, XIcon } from "@phosphor-icons/react";
import BugReport from "./BugReport";
import { SealWarningIcon } from "@phosphor-icons/react";
import { useEffect, useState } from "react";
import { version as currentVersion } from "../../../package.json";
import {
    AlertDialog,
    AlertDialogContent,
    AlertDialogTitle,
    AlertDialogDescription,
    AlertDialogAction,
    Button,
} from "@openmarch/ui";
import VersionChecker from "../VersionCheck";
import FileControls from "./FileControls";
import { T } from "@tolgee/react";
import { useUiSettingsStore } from "@/stores/UiSettingsStore";

// eslint-disable-next-line max-lines-per-function
export default function TitleBar({ showControls }: { showControls?: boolean }) {
    const isMacOS = window.electron.isMacOS;
    const { uiSettings } = useUiSettingsStore();

    const [dbPath, setDbPath] = useState<string>("");
    const [dbPathError, setDbPathError] = useState<boolean>(false);

    useEffect(() => {
        const fetchDbPath = async () => {
            try {
                const path = await window.electron.databaseGetPath();
                setDbPath(path);
            } catch (error) {
                setDbPath(
                    "Failed to fetch .dots file path! Fully quit the app and try again. If the issue persists, please reach out to support",
                );
                setDbPathError(true);
                console.error("Error fetching database path:", error);
            }
        };

        void fetchDbPath();
    }, []);

    const displayDbPath = uiSettings.showFullDatabasePath
        ? dbPath
        : (dbPath
              .split(/[/\\]/)
              .filter((segment) => segment.length > 0)
              .pop() ?? dbPath);

    return (
        <>
            <AlertDialog open={dbPathError}>
                <AlertDialogContent>
                    <div className="flex flex-col items-center gap-12">
                        <SealWarningIcon size={48} className="text-red" />
                        <AlertDialogTitle>
                            <T keyName="titlebar.databasePathError" />
                        </AlertDialogTitle>
                        <AlertDialogDescription>
                            <T keyName="titlebar.databasePathError.description" />
                        </AlertDialogDescription>
                        <AlertDialogAction>
                            <Button
                                variant="primary"
                                onClick={() => setDbPathError(false)}
                            >
                                <T keyName="titlebar.databasePathError.dismiss" />
                            </Button>
                        </AlertDialogAction>
                    </div>
                </AlertDialogContent>
            </AlertDialog>
            <div className="main-app-titlebar text-text relative flex h-fit w-full items-center justify-between">
                <div
                    className={`flex items-center gap-20 px-24 py-8 ${isMacOS && "ml-64"}`}
                >
                    {!isMacOS && (
                        <button
                            className="titlebar-button hover:text-accent cursor-pointer outline-hidden duration-150 ease-out focus-visible:-translate-y-4"
                            onClick={() => {
                                window.electron.openMenu();
                            }}
                        >
                            <ListIcon size={18} />
                        </button>
                    )}
                    <div className="flex items-center gap-12">
                        <MarcherLogo />
                        <p className="text-body min-w-0 leading-none">
                            OpenMarch
                        </p>
                        <p className="text-body leading-none opacity-50">
                            {currentVersion}
                        </p>
                        <VersionChecker />
                        {showControls && <FileControls />}
                    </div>
                </div>
                <p className="text-sub absolute top-1/2 left-1/2 w-[30%] -translate-x-1/2 -translate-y-1/2 text-center">
                    {displayDbPath}
                </p>
                <div
                    className={`titlebar-button flex gap-12 ${isMacOS ? "pr-24" : ""}`}
                >
                    <BugReport />
                    {!isMacOS && (
                        <div className="titlebar-button flex">
                            <button
                                className="hover:text-accent focus-visible:text-accent cursor-pointer px-16 py-8 outline-hidden duration-150 ease-out"
                                onClick={() => {
                                    window.electron.minimizeWindow();
                                }}
                            >
                                <MinusIcon size={20} />
                            </button>
                            <button
                                className="hover:text-accent focus-visible:text-accent cursor-pointer px-16 py-8 outline-hidden duration-150 ease-out"
                                onClick={() => {
                                    window.electron.maximizeWindow();
                                }}
                            >
                                <SquareIcon size={20} />
                            </button>
                            <button
                                className="hover:text-red focus-visible:text-red cursor-pointer px-16 py-8 pr-24 outline-hidden duration-150 ease-out"
                                onClick={() => {
                                    window.electron.closeWindow();
                                }}
                            >
                                <XIcon size={20} />
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </>
    );
}

function MarcherLogo() {
    return (
        <svg
            width="8"
            height="21"
            viewBox="0 0 8 21"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            className="text-accent"
        >
            <path
                d="M7.05771 6.39284C7.02918 6.48923 6.9973 6.58227 6.96038 6.67279C6.79961 7.07437 6.56735 7.44354 6.27486 7.76243C6.17788 7.86783 6.07507 7.96773 5.96692 8.06166C5.95145 8.4699 5.85685 8.87126 5.68835 9.2435C5.51508 9.62472 5.23201 9.94572 4.87529 10.1655C4.4979 10.376 4.07284 10.4866 3.64059 10.4866C3.20834 10.4866 2.78329 10.376 2.4059 10.1655C2.04874 9.94478 1.76429 9.6242 1.58781 9.2435C1.41631 8.87209 1.3202 8.4704 1.30504 8.06166C1.19637 7.96889 1.09379 7.86922 0.99794 7.76327C0.704444 7.44498 0.471817 7.07567 0.31158 6.67363C0.2755 6.58478 0.243616 6.49342 0.215926 6.40122C0.0676727 6.85716 -0.00516403 7.3342 0.000284531 7.81356C0.000284531 8.57295 0.154953 9.23875 0.464291 9.81095C0.757347 10.3692 1.20162 10.8339 1.74639 11.152C2.31924 11.4794 2.97027 11.6454 3.63011 11.6323C4.2986 11.6467 4.95862 11.4808 5.54067 11.152C6.08627 10.8366 6.52957 10.3711 6.81774 9.81095C7.1198 9.23763 7.27083 8.57184 7.27083 7.81356C7.27629 7.33165 7.20434 6.85198 7.05771 6.39284Z"
                fill="currentColor"
            />
            <path
                d="M7.13994 5.40546C6.9848 6.15862 6.59063 6.84172 6.01596 7.35332C5.4413 7.86491 4.71678 8.17773 3.95 8.24531C3.18322 8.31289 2.41507 8.13163 1.75961 7.72845C1.10415 7.32527 0.596339 6.72167 0.31158 6.00727C0.233465 5.81256 0.17336 5.61112 0.132018 5.40546C0.129579 5.39293 0.129897 5.38002 0.13295 5.36762C0.136004 5.35523 0.141721 5.34364 0.149703 5.33368C0.157686 5.32371 0.167744 5.31559 0.179179 5.3099C0.190614 5.3042 0.203153 5.30106 0.215925 5.30068H7.05016C7.06338 5.30034 7.07651 5.30295 7.08859 5.30832C7.10068 5.31369 7.11141 5.32169 7.12001 5.33172C7.12861 5.34176 7.13486 5.35359 7.13831 5.36634C7.14176 5.3791 7.14231 5.39246 7.13994 5.40546Z"
                fill="currentColor"
            />
            <path
                d="M7.15925 1.55316V4.75083C7.15925 4.79529 7.14157 4.83793 7.1101 4.86937C7.07863 4.90081 7.03594 4.91847 6.99144 4.91847H0.278868C0.234361 4.91847 0.191676 4.90081 0.160205 4.86937C0.128734 4.83793 0.111053 4.79529 0.111053 4.75083V1.54142C0.111455 1.4727 0.133469 1.40585 0.173984 1.35032C0.406406 1.02929 1.32267 0 3.54117 0C5.75968 0 6.80013 1.01672 7.07954 1.3411C7.13075 1.39992 7.15905 1.4752 7.15925 1.55316Z"
                fill="currentColor"
            />
            <path
                d="M5.79827 12.6055L3.6427 14.5056L1.43678 12.6055H0.0481186V20.015H1.22282L1.24295 14.509L3.18457 15.809H4.10335L6.04412 14.4981L6.02398 20.015H7.19868V12.6055H5.79827Z"
                fill="currentColor"
            />
            <path
                d="M1.95279 16.5139H5.11944L5.13287 16.9456H1.93853L1.95279 16.5139Z"
                fill="currentColor"
            />
            <path
                d="M2.13405 17.7762H4.97179L4.98354 18.2079H2.12063L2.13405 17.7762Z"
                fill="currentColor"
            />
            <path
                d="M2.41597 19.0385H4.87025L4.88116 19.4694H2.40506L2.41597 19.0385Z"
                fill="currentColor"
            />
            <path
                d="M2.31613 16.9741C2.318 17.0048 2.31357 17.0356 2.3031 17.0645C2.29262 17.0934 2.27633 17.1199 2.25523 17.1423C2.23412 17.1647 2.20865 17.1826 2.18038 17.1948C2.15211 17.207 2.12164 17.2133 2.09084 17.2133C2.06004 17.2133 2.02956 17.207 2.00129 17.1948C1.97302 17.1826 1.94755 17.1647 1.92644 17.1423C1.90534 17.1199 1.88905 17.0934 1.87858 17.0645C1.8681 17.0356 1.86367 17.0048 1.86555 16.9741C1.80428 16.969 1.74717 16.9411 1.70554 16.8959C1.66391 16.8507 1.6408 16.7916 1.6408 16.7302C1.6408 16.6688 1.66391 16.6096 1.70554 16.5644C1.74717 16.5192 1.80428 16.4913 1.86555 16.4863C1.86897 16.4426 1.88506 16.4008 1.91185 16.3661C1.93864 16.3314 1.97497 16.3053 2.01639 16.2909C2.05782 16.2765 2.10254 16.2745 2.14511 16.2851C2.18767 16.2957 2.22622 16.3184 2.25605 16.3505C2.28587 16.3826 2.30569 16.4228 2.31306 16.4659C2.32044 16.5091 2.31506 16.5535 2.29757 16.5937C2.28009 16.6339 2.25127 16.6681 2.21463 16.6922C2.17799 16.7163 2.13512 16.7292 2.09126 16.7293C2.15351 16.7322 2.21211 16.7595 2.25425 16.8054C2.29638 16.8512 2.31863 16.9119 2.31613 16.9741Z"
                fill="currentColor"
            />
            <path
                d="M2.40506 18.2355C2.40693 18.2663 2.4025 18.297 2.39202 18.326C2.38155 18.3549 2.36526 18.3814 2.34416 18.4038C2.32305 18.4262 2.29758 18.444 2.26931 18.4563C2.24104 18.4685 2.21056 18.4748 2.17976 18.4748C2.14897 18.4748 2.11849 18.4685 2.09022 18.4563C2.06195 18.444 2.03648 18.4262 2.01537 18.4038C1.99427 18.3814 1.97798 18.3549 1.9675 18.326C1.95703 18.297 1.9526 18.2663 1.95447 18.2355C1.89321 18.2305 1.8361 18.2026 1.79447 18.1574C1.75283 18.1122 1.72972 18.053 1.72972 17.9916C1.72972 17.9302 1.75283 17.8711 1.79447 17.8259C1.8361 17.7807 1.89321 17.7528 1.95447 17.7477C1.95806 17.7041 1.97428 17.6624 2.00116 17.6279C2.02803 17.5933 2.06441 17.5673 2.10583 17.553C2.14726 17.5387 2.19195 17.5368 2.23445 17.5475C2.27695 17.5582 2.31542 17.581 2.34517 17.6131C2.37492 17.6453 2.39465 17.6854 2.40197 17.7285C2.40929 17.7717 2.40387 17.816 2.38637 17.8562C2.36888 17.8963 2.34007 17.9305 2.30345 17.9545C2.26684 17.9786 2.22401 17.9915 2.18018 17.9916C2.24228 17.9945 2.30075 18.0217 2.34287 18.0674C2.38498 18.113 2.40733 18.1735 2.40506 18.2355Z"
                fill="currentColor"
            />
            <path
                d="M2.70294 19.4978C2.70564 19.5291 2.70181 19.5606 2.69169 19.5902C2.68157 19.6199 2.66539 19.6472 2.64417 19.6703C2.62294 19.6934 2.59715 19.7119 2.56841 19.7245C2.53967 19.7371 2.50862 19.7436 2.47723 19.7436C2.44583 19.7436 2.41478 19.7371 2.38604 19.7245C2.35731 19.7119 2.33151 19.6934 2.31029 19.6703C2.28906 19.6472 2.27288 19.6199 2.26276 19.5902C2.25265 19.5606 2.24882 19.5291 2.25152 19.4978C2.19025 19.4928 2.13314 19.4649 2.09151 19.4197C2.04988 19.3745 2.02677 19.3153 2.02677 19.2539C2.02677 19.1925 2.04988 19.1334 2.09151 19.0882C2.13314 19.043 2.19025 19.0151 2.25152 19.01C2.25494 18.9661 2.27111 18.9242 2.29803 18.8894C2.32495 18.8545 2.36146 18.8283 2.40308 18.8138C2.44471 18.7994 2.48964 18.7974 2.53239 18.8081C2.57513 18.8188 2.61383 18.8417 2.64374 18.874C2.67365 18.9063 2.69347 18.9467 2.70079 18.9901C2.7081 19.0335 2.70258 19.0781 2.68491 19.1184C2.66724 19.1587 2.63818 19.193 2.60129 19.2171C2.5644 19.2412 2.52129 19.254 2.47723 19.2539C2.53948 19.2566 2.59816 19.2837 2.64045 19.3294C2.68274 19.3751 2.70521 19.4357 2.70294 19.4978Z"
                fill="currentColor"
            />
            <path
                d="M4.92897 16.9741C4.9271 17.0048 4.93153 17.0356 4.942 17.0645C4.95248 17.0934 4.96877 17.1199 4.98987 17.1423C5.01098 17.1647 5.03645 17.1826 5.06472 17.1948C5.09299 17.207 5.12347 17.2133 5.15426 17.2133C5.18506 17.2133 5.21554 17.207 5.24381 17.1948C5.27208 17.1826 5.29755 17.1647 5.31866 17.1423C5.33976 17.1199 5.35605 17.0934 5.36652 17.0645C5.377 17.0356 5.38143 17.0048 5.37955 16.9741C5.44082 16.969 5.49793 16.9411 5.53956 16.8959C5.58119 16.8507 5.6043 16.7916 5.6043 16.7302C5.6043 16.6688 5.58119 16.6096 5.53956 16.5644C5.49793 16.5192 5.44082 16.4913 5.37955 16.4863C5.37613 16.4426 5.36004 16.4008 5.33325 16.3661C5.30646 16.3314 5.27013 16.3053 5.22871 16.2909C5.18728 16.2765 5.14256 16.2745 5.09999 16.2851C5.05743 16.2957 5.01888 16.3184 4.98905 16.3505C4.95922 16.3826 4.93941 16.4228 4.93204 16.4659C4.92466 16.5091 4.93004 16.5535 4.94753 16.5937C4.96501 16.6339 4.99383 16.6681 5.03047 16.6922C5.06711 16.7163 5.10998 16.7292 5.15384 16.7293C5.09159 16.7322 5.03299 16.7595 4.99086 16.8054C4.94872 16.8512 4.92647 16.9119 4.92897 16.9741Z"
                fill="currentColor"
            />
            <path
                d="M4.79474 18.2355C4.79204 18.2668 4.79587 18.2982 4.80599 18.3279C4.81611 18.3576 4.83229 18.3849 4.85351 18.408C4.87473 18.4311 4.90053 18.4495 4.92927 18.4622C4.95801 18.4748 4.98906 18.4813 5.02045 18.4813C5.05184 18.4813 5.08289 18.4748 5.11163 18.4622C5.14037 18.4495 5.16617 18.4311 5.18739 18.408C5.20861 18.3849 5.2248 18.3576 5.23491 18.3279C5.24503 18.2982 5.24886 18.2668 5.24616 18.2355C5.30742 18.2305 5.36454 18.2026 5.40617 18.1574C5.4478 18.1122 5.47091 18.053 5.47091 17.9916C5.47091 17.9302 5.4478 17.8711 5.40617 17.8259C5.36454 17.7807 5.30742 17.7528 5.24616 17.7477C5.24273 17.7038 5.22657 17.6619 5.19965 17.6271C5.17273 17.5922 5.13622 17.566 5.0946 17.5515C5.05297 17.5371 5.00803 17.5351 4.96529 17.5458C4.92255 17.5565 4.88385 17.5794 4.85394 17.6117C4.82403 17.644 4.8042 17.6844 4.79689 17.7278C4.78958 17.7712 4.79509 17.8158 4.81277 17.8561C4.83044 17.8964 4.8595 17.9307 4.89639 17.9548C4.93327 17.9789 4.97639 17.9917 5.02045 17.9916C4.9582 17.9942 4.89952 18.0214 4.85723 18.0671C4.81493 18.1128 4.79247 18.1733 4.79474 18.2355Z"
                fill="currentColor"
            />
            <path
                d="M4.49435 19.4978C4.49247 19.5286 4.4969 19.5593 4.50738 19.5883C4.51785 19.6172 4.53414 19.6437 4.55524 19.6661C4.57635 19.6885 4.60182 19.7063 4.63009 19.7186C4.65836 19.7308 4.68884 19.7371 4.71964 19.7371C4.75044 19.7371 4.78091 19.7308 4.80918 19.7186C4.83745 19.7063 4.86293 19.6885 4.88403 19.6661C4.90513 19.6437 4.92142 19.6172 4.9319 19.5883C4.94237 19.5593 4.94681 19.5286 4.94493 19.4978C5.00619 19.4928 5.0633 19.4649 5.10494 19.4197C5.14657 19.3745 5.16968 19.3153 5.16968 19.2539C5.16968 19.1925 5.14657 19.1334 5.10494 19.0882C5.0633 19.043 5.00619 19.0151 4.94493 19.01C4.94134 18.9664 4.92512 18.9247 4.89825 18.8902C4.87137 18.8556 4.835 18.8296 4.79357 18.8153C4.75214 18.801 4.70745 18.7991 4.66495 18.8098C4.62245 18.8205 4.58398 18.8433 4.55423 18.8754C4.52448 18.9076 4.50475 18.9477 4.49743 18.9908C4.49012 19.034 4.49554 19.0783 4.51303 19.1185C4.53052 19.1586 4.55934 19.1928 4.59595 19.2168C4.63256 19.2409 4.6754 19.2538 4.71922 19.2539C4.65712 19.2568 4.59865 19.284 4.55653 19.3297C4.51442 19.3753 4.49207 19.4358 4.49435 19.4978Z"
                fill="currentColor"
            />
        </svg>
    );
}
