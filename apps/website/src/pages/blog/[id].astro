---
import { getCollection, render, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { ProseClass } from "@/components/ProseClass";
import MarkdownContent from "@/components/ui/MarkdownContent";
import {
    getPayloadPosts,
    isPayloadCmsEnabled,
    type PayloadPost,
} from "@/lib/payload";

export async function getStaticPaths() {
    const contentEntries = await getCollection("blog");
    const contentPaths = contentEntries.map((post) => ({
        params: { id: post.id },
        props: { source: "content" as const, post },
    }));

    if (!isPayloadCmsEnabled()) {
        return contentPaths;
    }

    const payloadPosts = await getPayloadPosts();
    const payloadPaths = payloadPosts.map((post: PayloadPost) => ({
        params: { id: `payload-${post.id}` },
        props: { source: "payload" as const, post },
    }));

    return [...contentPaths, ...payloadPaths];
}

type Props =
    | { source: "content"; post: CollectionEntry<"blog"> }
    | { source: "payload"; post: PayloadPost };

const { source, post } = Astro.props;
const isContent = source === "content";

const title = isContent ? post.data.title : post.title;
const author = isContent ? post.data.author : post.author;
const date = isContent ? post.data.date : new Date(post.date);
const dateFormatted = date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
    timeZone: "UTC",
});

const { Content } = isContent
    ? await render(post as CollectionEntry<"blog">)
    : { Content: null };
---

<Layout title={title}>
    <article
        class="flex relative max-w-[50rem] w-full flex-col items-center gap-16"
    >
        {
            isContent ? (
                <Image
                    src={
                        (post as CollectionEntry<"blog">).data
                            .image as ImageMetadata
                    }
                    width={1280}
                    height={720}
                    alt={title}
                    class="aspect-video h-auto w-full rounded-6 border border-stroke object-cover"
                />
            ) : (
                (() => {
                    const p = post as PayloadPost;
                    const img =
                        typeof p.featuredImage === "object"
                            ? p.featuredImage
                            : null;
                    return (
                        <img
                            src={img?.url ?? ""}
                            width={1280}
                            height={720}
                            alt={img?.alt ?? title}
                            class="aspect-video h-auto w-full rounded-6 border border-stroke object-cover"
                        />
                    );
                })()
            )
        }
        <div
            class="absolute top-[10vh] left-1/2 -z-50 w-full aspect-video h-auto -translate-x-1/2"
            style="background: radial-gradient(ellipse, oklch(from var(--color-accent) l c h / 0.3) 0%, transparent 70%);"
        >
        </div>
        <h1 class="text-h3 text-center">{title}</h1>
        <div class="flex gap-16">
            <p class="text-body">by {author}</p>
            <p class="text-body">{dateFormatted}</p>
        </div>
        {
            isContent && Content ? (
                <div class={ProseClass}>
                    <Content />
                </div>
            ) : source === "payload" ? (
                <MarkdownContent
                    content={(post as PayloadPost).contentMarkdown ?? ""}
                />
            ) : null
        }
    </article>
</Layout>
