name: Desktop Release

on:
  push:
    tags: [v*]

permissions:
  contents: write # Required for creating releases

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os:
          - macos-latest
          - macos-15-intel # x86 (Intel) macOS
          - ubuntu-latest
          - ubuntu-24.04-arm

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Debug release output
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "Releasing version tag"

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0

      ############ LINUX ############
      - name: Install Snapcraft (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: sudo snap install snapcraft --classic

      - name: Install Snapcraft (Ubuntu ARM)
        if: matrix.os == 'ubuntu-24.04-arm'
        run: sudo snap install lxd

      - name: Setup LXD (Ubuntu ARM)
        if: matrix.os == 'ubuntu-24.04-arm'
        uses: canonical/setup-lxd@main

      - name: Validate Snapcraft credentials on Linux release
        if: startsWith(matrix.os, 'ubuntu')
        run: snapcraft whoami -q
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

      ############ MACOS ############
      - name: Prepare for app notarization
        if: startsWith(matrix.os, 'macos')
        run: |
          mkdir -p ~/private_keys/
          echo '${{ secrets.apple_api_key }}' > ~/private_keys/apple_api_key.p8

      ###############################

      - name: Create Sentry env file
        working-directory: apps/desktop
        shell: bash
        run: echo "SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}" > .env.sentry-build-plugin

      - name: Install pnpm dependencies
        run: pnpm install --no-frozen-lockfile
        env:
          CI: false

      - name: Ensure all @libsql platform packages are installed
        working-directory: apps/desktop
        run: |
          # Install all platform-specific @libsql packages without modifying package.json
          # This ensures they're available for Electron bundling across all platforms
          # We use --no-save to avoid modifying package.json
          pnpm add --no-save \
            @libsql/darwin-arm64@0.5.22 \
            @libsql/darwin-x64@0.5.22 \
            @libsql/linux-arm-gnueabihf@0.5.22 \
            @libsql/linux-arm-musleabihf@0.5.22 \
            @libsql/linux-arm64-gnu@0.5.22 \
            @libsql/linux-arm64-musl@0.5.22 \
            @libsql/linux-x64-gnu@0.5.22 \
            @libsql/linux-x64-musl@0.5.22 \
            @libsql/win32-x64-msvc@0.5.22 || true
        env:
          CI: false

      - name: Build for production
        run: pnpm run build --filter=\!@openmarch/website
        env:
          CI: false

      - name: Replace package name in package.json - ubuntu
        working-directory: apps/desktop
        if: startsWith(matrix.os, 'ubuntu')
        # needed to prevent "тип expected argument for flag '--executable' " error on linux
        run: |
          sed -i 's/"name": "@openmarch\/desktop"/"name": "OpenMarch"/g' package.json

      - name: Build/release Electron app
        uses: ./actions/desktop-deploy
        with:
          github_token: ${{ secrets.github_token }}
          release: true
          mac_certs: ${{ secrets.mac_certs }}
          mac_certs_password: ${{ secrets.mac_certs_password }}
          max_attempts: 5
        env:
          APPLE_API_KEY: "~/private_keys/apple_api_key.p8"
          APPLE_API_KEY_ID: ${{ secrets.apple_api_key_id }}
          APPLE_API_ISSUER: ${{ secrets.apple_api_key_issuer }}
          # also put in camelCase for electron/notarize
          appleApiKey: "~/private_keys/apple_api_key.p8"
          appleApiKeyId: ${{ secrets.apple_api_key_id }}
          appleApiIssuer: ${{ secrets.apple_api_key_issuer }}
          CSC_IDENTITY_AUTO_DISCOVERY: true
          # For releasing
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
          SNAPCRAFT_BUILD_ENVIRONMENT: lxd

      - name: Promote snap to stable channel
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          # Get the latest revision for this architecture
          ARCH=$(dpkg --print-architecture)
          REVISION=$(snapcraft list-revisions openmarch --arch=$ARCH | head -n 2 | tail -n 1 | awk '{print $1}')
          if [ -n "$REVISION" ]; then
            echo "Promoting revision $REVISION to stable channel for arch $ARCH"
            snapcraft release openmarch "$REVISION" stable
          else
            echo "No revision found to promote"
            exit 1
          fi
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always() # Upload even if previous steps fail
        with:
          name: ${{ matrix.os }}-artifacts
          path: apps/desktop/release/*
          retention-days: 30
          if-no-files-found: warn

  windows-build-and-release:
    runs-on: windows-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Debug release output
        shell: pwsh
        run: |
          Write-Output "GITHUB_REF=$env:GITHUB_REF"
          Write-Output "Releasing version tag"

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0

      - name: Create Sentry env file
        working-directory: apps/desktop
        shell: bash
        run: echo "SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}" > .env.sentry-build-plugin

      - name: Install pnpm dependencies
        run: pnpm install --no-frozen-lockfile
        env:
          CI: false

      - name: Ensure all @libsql platform packages are installed
        working-directory: apps/desktop
        shell: pwsh
        run: |
          # Install all platform-specific @libsql packages without modifying package.json
          # This ensures they're available for Electron bundling across all platforms
          # We use --no-save to avoid modifying package.json
          pnpm add --no-save `
            @libsql/darwin-arm64@0.5.22 `
            @libsql/darwin-x64@0.5.22 `
            @libsql/linux-arm-gnueabihf@0.5.22 `
            @libsql/linux-arm-musleabihf@0.5.22 `
            @libsql/linux-arm64-gnu@0.5.22 `
            @libsql/linux-arm64-musl@0.5.22 `
            @libsql/linux-x64-gnu@0.5.22 `
            @libsql/linux-x64-musl@0.5.22 `
            @libsql/win32-x64-msvc@0.5.22
        env:
          CI: false
        continue-on-error: true

      - name: Build for production
        run: pnpm run build --filter "!@openmarch/website"
        env:
          CI: false

      - name: Build/release Electron app for Windows
        run: |
          cd apps/desktop
          pnpm exec .\node_modules\.bin\electron-builder -w --publish=always --config electron-builder-sign.json5
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          # For releasing
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always() # Upload even if previous steps fail
        with:
          name: windows-latest-artifacts
          path: apps/desktop/release/*
          retention-days: 30
          if-no-files-found: warn
